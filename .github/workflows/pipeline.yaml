name: CI-CD-JS-workflow

# A pipeline will be activated every time on push to main, or pull request to main 
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  Build:
    # using the latest ubunt for the build process
    runs-on: ubuntu-latest

    # downloading the code from the repo
    steps:
    - name: Downloading the Code
      uses: actions/checkout@v4

    # setup node js
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    # installing dependencies
    - name: Installing dependencies
      run: npm install

    # uploading the artifacts
    - name: Uploading Artifact
      uses: actions/upload-artifact@v4
      with:
        name: production-code
        # everything from the root folder will be stored into the artifact 
        path: |
          src/
          tests/
          .eslintrc.json
          package.json
          package-lock.json
          node-modules/

  Linter:
      # step to check for errors and bad code style
      name: Code checking with Linter
      runs-on: ubuntu-latest
      # this step should be performed after the building job 
      needs: [Build]
      permissions:
        # allows the job to download the code and read the code 
        contents: read
        # allows the job to download and read the dependencies 
        packages: read
        # allows to write info for the pipeline
        statuses: write
      
      steps:
         # Downloading the artifact created in Build process
        - name: Downloading the artifact
          uses: actions/download-artifact@v4
          with:
            name: production-code
            path: .

        # Setup Node js
        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
            node-version: '20'

        # Installing dependencies
        - name: Install dependencies
          run: npm install

        - name: Configuration esling init
          run: npm init @eslint/config@latest -- --config eslint-config-xo

        # running linting
        - name: Run Linter
          run: npm run lint

  Unit-Tests:
      name: Performing UTs
      runs-on: ubuntu-latest
      # Starts the Unit Tests after the lintering job is finished
      needs: [Linter]
      permissions:
        # allows the job to download the code and read the code 
        contents: read
        # allows the job to download and read the dependencies 
        packages: read
        # allows to write info for the pipeline
        statuses: write

      steps:
        # Downloading the artifact created in Build process
        - name: Downloading the artifact
          uses: actions/download-artifact@v4
          with:
            name: production-code
            path: .

        # Set up node js
        - name: Setup Node.Js
          uses: actions/setup-node@v4
          with: 
            node-version: '20'

        # installing dependencies
        - name: Installing dependencies
          run: npm install

        # Running tests to be performed every time a new commit is inserted
        - name: Running test
          run: npm test 
        
  SAST-Security:
      name: Security analyzer with CodeQL
      runs-on: ubuntu-latest
      # Starts the SAST security check after the lintering job is finished
      needs: [Unit-Tests]
      permissions:
        # allows the job to download the code and read the code 
        contents: read
        # allows the job to download and read the dependencies 
        packages: read
        # allows to write info for the pipeline
        statuses: write
        # allows permission to write security information in Security tab in Github 
        security-events: write

      steps:
        # Downloading the code from the repo
        - name: Downloading code from repo
          uses: actions/checkout@v4

        # Initializing CodeQl 
        # CodeQl is used to find vulnerabilities 
        - name: Initialize CodeQL
          uses: github/codeql-action/init@v3
          with:
            languages: 'javascript'
            
        - name: Perform CodeQL Analysis
          uses: github/codeql-action/analyze@v3

  SCA-Security:
      name: Security dependency analizer with Trivy
      # Runs on the latests ubuntu release
      runs-on: ubuntu-latest
      # Starts after UnitTesting, parallel execution with SAST
      needs: [Unit-Tests]
      permissions:
        # allows the job to download the code and read the code 
        contents: read
        # allows the job to download and read the dependencies 
        packages: read
        # allows to write info for the pipeline
        statuses: write
         # allows permission to write security information in Security tab in Github 
        security-events: write 
    
      steps:
        # Downloading code from repo
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Run Trivy Scanner for Dependencies
          uses: aquasecurity/trivy-action@master
          # configuration trivy
          with:
          # trivy will scan all file systems searching for deependency files, it wont scan docker image
            scan-type: 'fs'
            # scan the current directory (meaning the whole project)
            scan-ref: '.'
            # in case of error or unsuccess, it will throw error code 1
            exit-code: '1'
            # trivy will fail and it will show only those errors that are CRITICAL or HIGH
            severity: 'CRITICAL,HIGH'

  Docker-Build-Push:
    name: Docker build with push to DockerHub
    runs-on: ubuntu-latest
    # still step will be performed after the code security analysis
    needs: [SAST-Security, SCA-Security]

    steps:
      # downloading the code from repo
      - name: Checkout code
        uses: actions/checkout@v4
      # login to dockerhub
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
        # Gettings secrets that can be found in Github settins, those usernames and passwords are used to log in into dockerhub
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Buildx is an extension which is more modern and is ised to created the container
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Building and pushing the docker image to DockerHub
      - name: Build and push 
        uses: docker/build-push-action@v5
        with:
          # get everything in the current directory, in the main directory is the Dockerfile
          context: .
          # When the image is built, it shall be uploaded to DockerHub
          push: true
          # setting the latest label for the image, this specific commit will be used to specify the container 
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/my-app:latest
            ${{ secrets.DOCKER_USERNAME }}/my-app:${{ github.sha }}
  
  DockerImage-Security-Scan:
    name: DockerImage Security Scan
    runs-on: ubuntu-latest
    # after the docker image was uploaded to DockerHub, then it is download to be analysed
    needs: [Docker-Build-Push]
    
    steps:
      - name: Run Trivy on Docker Hub Image
        uses: aquasecurity/trivy-action@master
        with:
          # now it will search to analyse images
          scan-type: 'image'
          # tells exactly which image to search, download and scan
          image-ref: '${{ secrets.DOCKER_USERNAME }}/my-app:${{ github.sha }}'
          # logs will be shown in a table 
          format: 'table'
          # in case of a problem throw 1
          exit-code: '1'
          # trivy will fail and it will show only those errors that are CRITICAL
          severity: 'CRITICAL'
        # environment variables
        env:
          # Trivy is neede for docker username and docker password so it can download it and scan it
          TRIVY_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          TRIVY_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

  Deploy-Test-K8s:
    name: Test Deployment in Kubernetes (Kind)
    runs-on: ubuntu-latest
    # After the security scan on the image, proceed with Kubernetes deployment
    needs: [DockerImage-Security-Scan]
    
    steps:
      # Downloading code from repo 
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create k8s Kind Cluster
      # Starts Kubernetes cluster that will last only for a couple of minutes 
        uses: helm/kind-action@v1.9.0

      # creating the deployment manifest
      - name: Create Deployment Manifest
        # creating the yaml file for the deployment 
        run: |
          kubectl create deployment my-js-app \
            --image=${{ secrets.DOCKER_USERNAME }}/my-app:${{ github.sha }} \
            --replicas=1 \
            --port=3000 \
            --dry-run=client -o yaml > deployment.yaml

      - name: Apply to Cluster
        # creating the deployment with the generated yaml file
        run: kubectl apply -f deployment.yaml

      - name: Verify Deployment
        # this will wait here until the deployment is running correctly
        run: kubectl rollout status deployment/my-js-app --timeout=60s

        # Final smoke 
      - name: Perform Smoke Tests
        run: |
          kubectl port-forward deployment/my-js-app 3000:3000 &
          sleep 5
          
          curl --fail http://localhost:3000
          
          curl -s "http://localhost:3000/add?a=10&b=20" | grep "Result: 30"
          if [ $? -eq 0 ]; then
            echo "✅ Addition Logic works (10+20=30)"
          else
            exit 1
          fi
          
          curl -s "http://localhost:3000/subtract?a=50&b=20" | grep "Result: 30"
          if [ $? -eq 0 ]; then
             echo "✅ Subtraction Logic works (50-20=30)"
          else
             exit 1
          fi

          curl -s "http://localhost:3000/multiply?a=5&b=2" | grep "Result: 10"
          if [ $? -eq 0 ]; then
             echo "✅ multiply Logic works (5*2=10)"
          else
             exit 1
          fi

          echo "SUCCESS! App is running in Kubernetes!"
